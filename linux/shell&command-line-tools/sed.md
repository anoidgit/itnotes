# 简介

sed是一个按行处理的流编辑器（stream editor），它把当前处理的行存储在临时缓冲区中（称为“模式空间”，pattern space），再使用sed命令处理缓冲区中的内容。

 [sed手册](http://www.gnu.org/software/sed/manual/sed.html)

## 语法格式

语法格式：

```shell
#          选项          sed子命令               文件和标准输入
sed   [options]  <sed commands>   <file or stdin>

sed 选项 '子命令' 文件名
sed 选项 '子命令' <  标准输入
#可以指定多个 -e 和 -f 指定多个命令或脚本
sed 选项 -e '子命令1' -e '子命令2' 文件名
sed -f 脚本文件 文件名
sed -f 脚本1 -f 脚本2 文件名
```

**注意：sed不能编辑内容为空的文件（或标准输入）。**

## 常用选项

- `-e`或`--expression=命令`  多点编辑（可在执行多个子命令时使用）
- `-f`或`--file=脚本文件`  从文件中读取sed子命令（事先将sed子命令写入文件中供读取调用）


- `-i`或`--in-place[=SUFFIX]`  编辑文件内容并取代原文件
- `-n`或`--quiet`或`--silent` 安静模式 仅显示处理后的结果
- `-l`或`--line-length=N`   指定换行期望长度
- `-r`或`-regexp-extended`  启用扩展的正则表达式
- `-u`或`–unbuffered`  从输入文件中加载最少的数据，并更频繁的刷出到输出缓冲区
- `-z`或`–null-data`  使用NULL字符分割行（默认每一行使用换行符分割）

# sed子命令

- 多个子命令间使用`;`分隔

- 命令前使用`!`表示取反操作

- 子命令中引用变量
  - 子命令使用双引号，则变量外使用双引号或者不使用引号；

  - 子命令使用单引号，则变量外使用单引号：

    ```shell
    sed -i '/^TOPdir\s/c TOPdir = '$(pwd)'' Make.include
    sed -i "/^TOPdir\s/c TOPdir = $(pwd)" Make.include
    ```

  要保持变量名本身而不是变量的值，在$前使用\转义

  ```shell
  sed -i "/^LAdir\s/c LAdir = \$(MKLROOT)" Make.include
  ```

- 正则中需要转移使用的特殊字符

  sed子命令中扩展正则表达中使用以下特殊字符需要转义（一般的逻辑是：使用特殊字符本身所表示的的符号意义时才需要转义）

  `?  \  . () [] {}  ^  $ /`

  - `\?`  匹配0个或1个字符

  - `\+`  匹配1个及以上

  - `\|`  

  - `\( \)`  圆括号中内容为子表达式

  - `\{m,n\}`  花括号中内容为重复匹配的限定值（至少匹配m次，至多匹配n次，m和n均为自然数）

      ```shell
      sed -s s/^\s#\s(\test=1)/\1/  test.sh  #去掉注释
      ```

      提示：shell中使用\n表示回溯引用第n个子表达式（n为一个自然数，其中n为0时表示整个表达式本身）

  使用以下字符本身的符号意义时无需转义

  - `()`
  - `{}`

## 行定位

定位特定的某行或多行，交由其他sed命令（如`p`、`c`等）处理。

- 单行
  - 数字n：第n行
  - `^`和`$`：首行和末行
  - 正则`/pattern/`： 匹配该正则的那行

- 多行
  - 数字`m,n`：  第m到n行

  - 数字和正则混合`/pattern/,n`和`n,/pattern/`

  - 两个正则之间的行：/pattern1/,/pattern2/

  - `n!`  取反：除了第n行  m,n!

  - `n~x`：从第n行开始处理，下一次处理当前行后面的x行

    例如`1~2`表示从第1行开始处理，下一次处理当前行后面的第2行，也就是依次处理1，3，5，7……行

## 行打印 p

将模式空间写到标准输出。

注意：

使用`sed 'p' filename`会**将文件内容每行打印两次**(即使在p前面使用了正则匹配也会打印出文件所有内容)。

使用`-n`（或`--quiet`或`--silent`） 则仅将**匹配的内容打印一次**。

```shell
sed  --quiet '2,10p' file  #打印第2到10行
sed -n /pattern/p file  #打印匹配pattern的行
```

## 行编辑

- 替换匹配内容

  - 替换行  `c`

  - 替换字符 `y`

  - 替换字符串  `s`

     `s/原内容/新内容/`

  匹配标记（flag）

  - 缺省  替换第一个匹配的字符串
  - `\n`  第n个子表达式匹配的子串
  - `g`  全局匹配（替换文本行中所有匹配的字符串）
  - `w`  将模版空间中新的数据写入指定的文件
  - `i`  匹配时忽略大小写

  替换选项

  - `\n`  第n个子表达式匹配的子串
  - `&`  代表匹配的整个部分
  - `\L`  将在其后的替换部分转换成小写字母
  - `\l`：将下一个字符转换成小写字母
  - `\U`：将在其后的替换部分转换成大写字母
  - `\u`：将下一个字符转换成大写字母
  - `\E`：停止由`\L`或`\U`指示开始的大小写转换

- 新增行
  - `a`  在匹配项的**下一行**增加（append）
  - `i`   在匹配项的**上一行**插入（insert）
- 删除行  `d`
- 打印行  `p`
- 多行
  - N  将数据流中的下一行加进来创建一个多行组来处理
  - D  删除多行组中的一行
  - P  打印多行组中的一行

```shell
sed -i "s/aaa/bbb/" test  #替换test中所有aaa为bbb
sed -i "/hello/ s/aaa/bbb/" test  #替换test中含有hello的行的aaa为bbb

sed -i '2!d' filename #除了第二行外均删除
sed  -i -e '1a hello' -e '2i world' filename  #第一行后插入 第2行前插入
sed -i -e '1d' -e '2c new-world' filename  #删除第一行 替换第2行
```

## 模式空间与保持空间

模式空间（pattern space）和保持空间（hold space）均是处理文本内容行的**临时缓冲区**，两个缓冲区特性有所不同：

模式空间中的内容会主动打印到标准输出，并**自动清空**。

保持空间（或者叫保留空间、缓冲区）的内容**不会主动清空**，也不会主动打印到标准输出，**需要sed命令进行处理**。

- 空间内容操作命令
  - `N`  将下一行内容纳入当前缓冲区

    - `h`  将模式空间复制到保持空间
    - `H`  将模式空间附加到保持空间
    - `g`  将保持空间复制到模式空间
    - `G`  将保持空间附加到模式空间
    - `x`  交换模式空间和保持空间的内容
